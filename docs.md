<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

-   [intro][1]
-   [bot][2]
-   [mailbots][3]
-   [constructor][4]
    -   [Parameters][5]
-   [listen][6]
-   [exportApp][7]
-   [loadSkill][8]
    -   [Parameters][9]
-   [on][10]
    -   [Parameters][11]
-   [onCommand][12]
    -   [Parameters][13]
-   [onTrigger][14]
    -   [Parameters][15]
-   [onEvent][16]
    -   [Parameters][17]
-   [onAction][18]
    -   [Parameters][19]
-   [onTaskViewed][20]
    -   [Parameters][21]
-   [onSettingsViewed][22]
    -   [Parameters][23]
-   [onSettingsSubmit][24]
    -   [Parameters][25]
-   [initSdkApiClient][26]
    -   [Parameters][27]
-   [bot.webhook][28]
    -   [Parameters][29]
    -   [Examples][30]
-   [get][31]
    -   [Parameters][32]
    -   [Examples][33]
-   [set][34]
    -   [Parameters][35]
    -   [Examples][36]
-   [getTaskData][37]
    -   [Parameters][38]
-   [setTaskData][39]
    -   [Parameters][40]
    -   [Examples][41]
-   [getMailBotData][42]
    -   [Parameters][43]
    -   [Examples][44]
-   [setMailBotData][45]
    -   [Parameters][46]
    -   [Examples][47]
-   [getReferenceEmail][48]
    -   [Examples][49]
-   [setReferenceEmail][50]
    -   [Parameters][51]
    -   [Examples][52]
-   [getReplyTo][53]
    -   [Examples][54]
-   [getEmailMethod][55]
-   [sendEmail][56]
    -   [Parameters][57]
    -   [Examples][58]
-   [quickReply][59]
    -   [Parameters][60]
    -   [Examples][61]
-   [setTriggerTime][62]
    -   [Parameters][63]
    -   [Examples][64]
-   [setTriggerTimestamp][65]
    -   [Parameters][66]
    -   [Examples][67]
-   [invite][68]
    -   [Parameters][69]
    -   [Examples][70]
-   [completeTask][71]
    -   [Examples][72]
-   [discardTask][73]
    -   [Examples][74]
-   [getAllContacts][75]
    -   [Examples][76]
-   [respond][77]
    -   [Parameters][78]
    -   [Examples][79]
-   [settingsPage][80]
    -   [Parameters][81]
    -   [Examples][82]
-   [getSource][83]
    -   [Examples][84]
-   [getTrigger][85]
    -   [Examples][86]
-   [getUser][87]
    -   [Examples][88]
-   [getTask][89]
    -   [Examples][90]
-   [getMailBot][91]
    -   [Examples][92]
-   [setWebhookStatus][93]
    -   [Parameters][94]
    -   [Examples][95]
-   [addFutUiBlocks][96]
    -   [Parameters][97]
-   [bot.webook.settingsPage][98]
    -   [Examples][99]
-   [getSettingsFormJSON][100]
    -   [Examples][101]
-   [insert][102]
    -   [Parameters][103]
    -   [Examples][104]
-   [input][105]
    -   [Parameters][106]
    -   [Examples][107]
-   [textarea][108]
    -   [Parameters][109]
    -   [Examples][110]
-   [checkbox][111]
    -   [Parameters][112]
    -   [Examples][113]
-   [select][114]
    -   [Parameters][115]
    -   [Examples][116]
-   [alert][117]
    -   [Parameters][118]
    -   [Examples][119]
-   [video][120]
    -   [Parameters][121]
    -   [Examples][122]
-   [button][123]
    -   [Parameters][124]
    -   [Examples][125]
-   [setUrlParams][126]
    -   [Parameters][127]
-   [text][128]
    -   [Parameters][129]
    -   [Examples][130]
-   [hiddenInput][131]
    -   [Parameters][132]
    -   [Examples][133]
-   [submitButton][134]
    -   [Parameters][135]
    -   [Examples][136]
-   [populate][137]
    -   [Parameters][138]
    -   [Examples][139]

## intro

**Note** MailBots version 4+ is tightly coupled with FollowUpThen to reflect our (and our user's!) priorities.
FollowUpThen lifecycle hooks (ex: `mailbot.onFutTriggerUser`) allow a developer to add value to FollowUpThen (the original, proto-MailBot) by modifying behavior or injecting UI elements at different points in the followup lifecycle.

MailBots still exists a platform to extend FollowUpThen. We may re-release it as an independent system in the future.
If you'd like to see that happen, or have any feedback in general, feel free to email help@humans.fut.io.

[MailBots][140] is a platform for creating bots, AIs and assistants that get things done right from your inbox. Read more at [mailbots.com][140].

# Quick Start

Go to mailbots.com and create a MailBot. The bot creation process sets up a working instance of this framework.

Next, let's tell our MailBot what to do when it receives an email:

```javascript
var MailBot = require("mailbots");
var mailbot = new MailBot(); // assuming .env is set

// When someone emails: say-hi@my-bot.eml.bot, respond "Hello Human!"
mailbot.onCommand("say-hi", function(bot) {
  bot.webhook.quickReply("Hello Human!");
  bot.webhook.respond();
});

mailbot.listen();
```

`say-hi@my-bot.eml.bot` is an example of an "email command". Whatever is before the @ sign is a command to your bot to accomplish some task. [Read more about email commands][141].

# Docs

Tip: Use our [reference guide][142] to quickly look up helpers and method names.

<!-- START doctoc generated TOC please keep comment here to allow auto update -->

<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

-   [How MailBots Work][143]
    -   [Tasks][144]
    -   [Commands][145]
    -   [Triggering][146]
    -   [Architecture][147]
    -   [Handlers][148]
    -   [Skills][149]
-   [Examples:][30]
    -   [Hello World][150]
    -   [Set a Reminder][151]
    -   [Handle Action-Emails][152]
    -   [Install A Skill][153]
-   [Handler Reference][154]
    -   [onCommand][12]
    -   [onTrigger][14]
    -   [onAction][18]
    -   [onTaskViewed][20]
    -   [onEvent][16]
    -   [onSettingsViewed][22]
    -   [onSettingsSubmit][24]
    -   [on][10]
    -   [Handling Errors][155]
-   [FollowUpThen Lifecycle Hook Handlers][156]
    -   [onFutCreateUser][157]
    -   [onFutCreateNonUser][158]
    -   [onFutPreviewUser][159]
    -   [onFutPreviewNonUser][160]
    -   [onFutViewUser][161]
    -   [onFutViewNonUser][162]
    -   [onFutTriggerUser][163]
    -   [onFutTriggerNonUser][164]
    -   [onFutTaskUpdate][165]
    -   [onFutAction][166]
-   [The "bot" Object][167]
-   [Building Skills][168]
    -   [Sharing Handlers][169]
    -   [Sharing the "one-bot function"][170]
    -   [Handling Web Requests][171]
    -   [Middleware][172]
    -   [Namespacing Conventions][173]
-   [Installing Skills From npm][174]
    -   [Skills With Side-Effects][175]
-   [Welcoming New Users][176]
-   [Connecting 3rd Party Services][177]
    -   [OAuth][178]
-   [Testing][179]
-   [Installing][180]
-   [Contributions][181]

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# How MailBots Work

A MailBot's purpose is to help someone get something done quickly, efficiently and without leaving their inbox.

## Tasks

A unit of work accomplished by a MailBot is called a "task". Tasks can scheduled, edited or "completed". Tasks are always associated with a command.

## Commands

MailBots always work in the context of commands while accomplishing tasks. A command can be thought of as the instruction for how to complete a particular task, or the purpose of the task. Email Commands (shown above) are one way to issue commands. Creating a task with the API also requires a command.

## Triggering

A task (that carries out a command) can be created then wait for the perfect moment to notify a user. Timliness is a core feature of of a MailBot.

## Architecture

When events happen in the MailBots platform (ex: an email is received), your MailBot receives webhooks. Your MailBot then gets some useful bit of work done (ex: enters data into a CRM) and responds with JSON that tells the MailBots platform what to do next (ex: send an email, store data, set a reminder, etc). JSON in, JSON out.

This library simplifies much of the above architecture, allowing you to simply create handler functions for certain events.

The webhook request and response can be viewed via the [MailBots Sandbox][182].

## Handlers

MailBots are composed of handlers – functions that run when certain events occur. For example: _When the bot receives an email at this address, execute these actions_

## Skills

Handlers and other bot functionality can be packaged into "skills" – high-level abilities that can shared between bots. Here are some example skills:

-   Interact with a CRM
-   Parse natural language
-   Send a text message or Slack message
-   Render special UI elements

You can publish, share and install new skills from npm.

# Examples:

## Hello World

Create an [email command][141] that says hi.

```javascript
var MailBotsApp = require("mailbots");
var app = new MailBotsApp();

mailbot.onCommand("hi", function(bot) {
  bot.webhook.quickReply("Hi back!");
  bot.webhook.respond();
});

mailbot.listen();
```

## Set a Reminder

The first handler creates the reminder. The second one handles the reminder when it becomes due.

```javascript
mailbot.onCommand("hi", function(bot) {
  // Schedule the task to trigger in 1 minute
  bot.webhook.setTriggerTime("1min");
  bot.webhook.respond();
});

// When a task with "hi" command triggers, run this
mailbot.onTrigger("hi", function(bot) {
  bot.webhook.quickReply("Hi 1 minute later!");
  bot.webhook.respond();
});
```

## Handle Action-Emails

MailBots can render quick-action buttons (mailto links that map to executable code) that let users get things done without leaving their inbox. Read more about [action emails][183].

```javascript
// This first handler renders an email with an action-email button
 mailbot.onCommand("send-buttons", function(bot) {
    bot.webhook.sendEmail({
      to: bot.get('source.from')
      from: "MyBot",
      subject: bot.get('source.subject'),
      body: [

        // 👇 An email-action
        {
          type: "button",
          behavior: "action",
          text: "Press Me",
          action: 'say.hi',
          subject: "Just hit 'send'",
        }
      ]
    });
    bot.webhook.respond();
  };

  // This handler handles the email action
  mailbot.onAction('say.hi', function(bot) {
    bot.webhook.quickReply('hi');
    // Lots of useful things can be done here. Completing a todo item, adding notes to a CRM, etc.
    bot.webhook.respond();
  });

  mailbot.listen();
```

## Install A Skill

Let's install a skill to that extracts the email message from previously quoted emails and signatures.

```javascript
var mailbotsTalon = require("mailbots-talon");
mailbot.onCommand("hi", function(bot) {
  const emailWithoutSignature = mailbotsTalon.getEmail(bot);
  bot.quickReply(
    "Here is the email without the signature:" + emailWithoutSignature
  );
  bot.webhook.respond();
});
```

# Handler Reference

Note: The first matching event handler ends the request, even if subsequent handlers also match, except where otherwise noted.

## onCommand

    mailbot.onCommand(command, handlerFn)

Handle when an [email command][184] is received. This also fires when a new task is created via the API (All tasks have a command to define their purpose or reason for existence.)

```javascript
mailbot.onCommand("todo", function(bot) {
  //handle when a task is created with this command string
});
```

Regular expressions work with all handlers.

```javascript
mailbot.onCommand(/todo.*/, function(bot) {
  //Handle todo.me@my-ext.eml.bot, todo.you@my-ext.eml.bot, todo.everyone@my-ext.eml.bot
});
```

## onTrigger

    mailbot.onTrigger(command, handlerFn)

Timeliness is a MailBot superpower. A user can schedule a task, then days, months or years later your bot can follow up at the exact right moment – scheduled by the user, or by another event. Read more about [triggering][185].

Tasks with different commands may trigger differently. For example:

```javascript
mailbot.onTrigger("todo.me", function(bot) {
  // Assigned to myself, so only remind me
});
```

```javascript
mailbot.onTrigger("todo.assign", function(bot) {
  // Assigned to the person in the 'to' field, so remind them
});
```

```javascript
mailbot.onTrigger("todo.crm", function(bot) {
  // Query CRM API, populate email followup with contact data
});
```

## onAction

    mailbot.onAction(action, handlerFn)

Handle when a user performs an action that relates to a task.

For example a user can send an [action-email][183] to accomplish an action without leaving their inbox (postponing a reminder, completing a todo item, logging a call, etc).

```javascript
mailbot.onAction("complete", function(bot) {
  // Complete the related todo
});
```

**MailBot Conversations**

Set the reply-to address of a MailBot email to an action email to carry out a conversation with the user.

```javascript
mailbot.onAction("assistant", function(bot) {
  // Use luis-ai middlweare to dtermine intent
  // Store conversation state
  // send-email whose reply-to is also "assistant"
});
```

## onTaskViewed

    mailbot.onTaskViewed(command, handlerFn)

Handle when a task is viewed in the MailBots Web UI, allowing a user to view and interact with a future MailBots email.

```javascript
mailbot.onTaskViewed("todo.me", function(bot) {
  // Show a preview of the future email
});
```

Different task commands may render differently. For example a task with command `todo.crm` may query and render current CRM data within the preview.

## onEvent

    mailbot.onEvent(event, handlerFn)

Handle when the MailBot receives an inbound webhok from a 3rd party system about an external event. For example, a support ticket is created or a lead is added to a CRM.

Note: This action does not automatically create a MailBots Task. One can be created with [mailbots-sdk][186]

```javascript
mailbot.onEvent("issue.created", async function(bot) {
  // Handle event, for example, create a MailBots Task.
  const mailBotsClient = MailBotsClient.fromBot(bot);
  await mailBotsClient.createTask({
    // Pre-authenticated API client
  });
  bot.webhook.respond({ webhook: { status: "success" } });
});
```

## onSettingsViewed

    mailbot.onSettingsViewed(handlerFn)

Handle when a user views this MailBot's settings.

Bots can build custom settings pages. These are rendered when a user views bot settings on the MailBots.com admin UI.

See the [settings page reference][187].

The handler's only parameter is a callback function that responds with JSON to to render a settings form. The callback function is passed the `bot` object as usual.

Settings form JSON can be easily built using the [settings helper functions][187].

Unlike the other handlers, every instance of this handler is called. (ie, all settings pages from all settings handlers are rendered).

NOTE: Do not call `bot.webhook.respond()` at the end of this particular request. MailBots' internals take care of compiling the JSON and responding.

```javascript
// Render a settings field for the user to enter their first name
mailbot.onSettingsViewed(async function(bot) {
  const todoSettings = bot.webhook.settingsPage({
    namespace: "todo",
    title: "Todo Settings", // Page title
    menuTitle: "Todo" // Name of menu item
  });
  todoSettings.setUrlParams({ foo: "bar" }); // send a URL param (useful for showing dialogs)
  const urlParams = bot.get("url_params"); // retrieve URL params (see below)
  todoSettings.input({ name: "first_name", title: "First name" });
  todoSettings.buton({ type: "submit" });

  // Populate form values
  todoSettings.populate(bot.get("mailbot.stored_data.todo"));
  // Note bot.webhook.respond() is NOT called
});
```

URL parameters are passed through to the settings webhook. Use this to pass data into your settings when linking to it or displaying dialogs to the users (see above handler)

```javascript
mailbot.onSettingsViewed(function(bot) {
  const settingsPage = bot.webhook.settingsPage({ namespace: "todo" });
  const urlParams = bot.get("url_params", {}); //defualts to empty object

  if (urlParams.linkInstructions)) {
    settings.text(`# Instructions to link your account!`);
  }
  // Note that there is no submit button. It's just an informational page.
});
```

You can also pass URL params via the `urlParams` key in the `button` form element (it must be type:`submit`);

```javascript
// within a onSettingsViewed form as shown above
settings.button({
  submitText: "Save Notification Settings",
  type: "submit",
  urlParams: { saveSettings: 1 }
  // Tip: Pass through all URL current params, but use caution! (see note)
  // urlParams: {saveSettings: 1, ...bot.get("url_params", {})}
});
```

NOTE: URL parameters are an easy way to pass data into your bot settings, but **keep this in mind while using URL params**: Anyone can link a user to their settings page with _anything_ in URL. Do not, for example, create a url like: `/settings?delete_everything=true` that deletes all their tasks. An unsuspecting user may arrive on their settings page from an external link, not see this in the URL and submit the form only find themselves without any data. [Read more][188].

## onSettingsSubmit

    mailbot.onSettingsSubmit(handlerFn)

Handle when the user submits their settings.

To persist the newly saved data, it must be explicitly saved. Use `bot.webhook.saveMailBotData()` or
`bot.set("mailbot.stored_data")` or API calls to do this.

Newly submitted values are available under `settings`.

Previously saved values are available under the `mailbot.stored_data`.

Every instance of this handler is called when any settings form is saved (similar to the above `onSettingsViewed` handler)

This handler is a good place begin an oauth handshake, set up data in other system or perform API calls to
other systems.

```javascript
mailbot.onSettingsSubmit(bot => {
  // assuming the same "todo" namespace as shown in the above examples
  const data = bot.get("settings.todo");

  // handler is fired any times settings are saved, even if its not our form
  if (!data) return;

  // perform API calls, validate connections, update external systems here

  // validate or modify data, then save it.
  bot.set("mailbot.store_data.todo", data);

  // This error would show to the user
  if (error) {
    bot.webhook.respond({
      webhook: {
        status: "error",
        message: "This is  a warning message"
      }
    });
  }
  return;
});
```

### URL Params

URL params are useful for passing data into settings handlers, showing dialogs and more. We tried to preserve the mental model of URL parameters while working with settings forms, but but it does not always apply exactly.

In the onSettingsSubmit handler, you need to pass `url_params` parameters through the webhoook response:

```javascript
// in onSettingsSubmit handler
bot.set("url_params", { show_success_dialog: "true" });
```

This is now accessible as a "url_param" in your `onSettingsViewed` handler. You will also see it as a URL
param in the settings UI:

```javascript
// in the onSettingsViewed handler, render a dialog with a button that dismisses the dialog
// const settingsForm set up earlier
const urlParams = bot.get("url_params", {});
if (urlParams.show_success_dialog) {
  settingsForm.text("# Success \nYour todo list has been set up!");
  settingsForm.button({ type: "submit",  text: "dismiss", urlParams({ dismissSuccess: true }) });
};
```

You can also set URL parameters using the `button` element which can trigger different actions based on the URL
(Note the CSR caution above).

```javascript
// back ino onSettingsSubmit handler.
if (bot.get("url_params.dissmissSuccess")) {
  bot.saveMailBotData("todo.show_success_dialog", null); // set to null to clear the value
}
```

Setting URL parameters in the `onSettingsViewed` hook requires a different method:

```javascript
// onSettingsViewed
// Force the page to have specific URL params
settingsPage.setUrlParams({ key: "value" });

// Force the settings page to have no URL params
settingsPage.setUrlParams({});
```

## on

    mailbot.on(webhookEvent, handlerFn)

This is a generic handler for any webhook. It can be used to handle any inbound webhook – mainly ones that are not covered by the handlers above. (Of note: The handlers above are simply wrappers for this lower-level handler).

Example:

```javascript
mailbot.on("mailbot.installed", function(bot) {
  // Handle when a MailBot is installed
  // Create task with MailBots SDK
  // bot.webhook.respond();
});
```

The first paramater can be:

-   A string that matches the webhook `type`. (ie. [`mailbot.installed`][189])
-   A regular expression that matches on webhook `type`
-   A function that takes the incoming webhook as the only parameter and returns a boolean value indicating whether or not that webhook should be handled by that function handler.

The second parameter is the function handler that runs only if the matching condition (the first parameter) is met.

```javascript
mailbot.on("mailbot.installed", function(bot) {
  // Handle when a MailBot is installed
  // Create a task from mailbots sdk
  // bot.webhook.respond();
});
```

## Handling Errors

Ideally, error conditions are handled within the normal application flow. If something unexpected happens you can set up a custom error handler for adding logs, alerting or providing error messaging to users.

If you want to send the user your own error email, use the [sendEmail][190] method from the MailBots SDK. (Not all webhook responses send emails).

```javascript
// define a custom error handler
app.setErrorHandler(function(error, bot) {
  // myCustomLogger.log(error);
  // send email with mailbots sdk
  // send a custom error email to user
  // Respond with 5xx status code to send the generic MailBots error email to the user
  // bot.response.status(500);

  bot.webhook.respond({
    status: "error",
    message: "A custom error message" // Shown to user if in the web UI.
  }); // A webhook response must be sent
});
```

# FollowUpThen Lifecycle Hook Handlers

The below handlers are fired in response to FollowUpThen lifecycle events. Their response signature
differs from the native MailBots handlers above since it is injecting UI elements and behavioral changes
into the followup cycle.

The response style for all FollowUpThen Lifecycle Hook handlers is shown in onFutCreateUser below.

Available options for the response are described in the `ISkillReturnValue` interface within `types.ts`

## onFutCreateUser

Modify the FollowUpThen user's confirmation email or modify the task object when a followup is created.

```javascript
mailbot.onFutCreateUser(bot => {
  bod.webhook.addFutUiBlocks([
    {
      type: "text",
      text: "Text block"
    }
  ]);
});

// using native JSON response with TypeScript
mailbot.onFutCreateUser(bot => {
  const ISkillReturnValue: response = {
    futUiAddition: [
      {
        type: "text",
        text: "Text block"
      }
    ]
  };
  bot.responseJson = response;
  return;
});
```

## onFutCreateNonUser

In rare cases (currently only when a [task (-t)][191] type
followup is being created, a non-FUT user receives an email which can be modified using the above hook.

## onFutPreviewUser

Render of UI elements into the preview email. (Shown when when a FUT user clicks "preview"
to see what a reminder format will do). These elements are usually identical to the ones shown in the
`onFutViewUser` and `onFutTriggerUser` hooks.

## onFutPreviewNonUser

If a preview will trigger the a followup to a non-FUT user (ie, when used in "cc"), this allows allows
for a preview of what this will look like.

## onFutViewUser

Render UI elements when a user is viewing a followup.

## onFutViewNonUser

If a FUT has emails sent to non-users, use this to render UI elements for only the non-user email.

## onFutTriggerUser

Render UI elements that are only visible to the FollowUpThen user when a followup becomes due.

## onFutTriggerNonUser

Render UI elements that are only for the non-user when a followup becomes due (if the followup format has
a non-user email component).

## onFutTaskUpdate

Take action when a task is edited. This may involve creating, removing or unlinking a linked resource.

## onFutAction

The UI elements above may trigger email-based actions (fired from email, or from the FUT UI). This handler
allows for the handling of these actions.

# The "bot" Object

The `bot` object passed to the handlers above contains useful helpers that make it easy to handle bot requests. See [webhook helpers reference docs][192].

**Setting Data Works By Shallow Merging**
Data is set by shallow merging. For example.

```javascript
bot.webhook.setTaskData("my_namespace", { name: "Joe" });
bot.webhook.setTaskData("my_namespace", { key: "123" });
// task data is now
console.log(bot.webhook.responseJson);
// {my_namespace: { name: "Joe", key: "123" }}
```

```javascript
bot.webhook.setTaskData("my_namespace", {
  name: "Joe",
  data: { value: "here" } // ⚠️ Overwritten (shallow merge)
});
bot.webhook.setTaskData("my_namespace", {
  data: { value2: "there" }
});
// task data is now
console.log(bot.webhook.responseJson);
// {my_namespace: { data: { value2: "there" } }}
```

# Building Skills

"Skills" are sharable pieces of bot functionality. Skills can encapsulate everything they need (handlers, settings panels helper funcitons and UI elements) so they are ready for use installed. They are great for keeping your code organized and for sharing functionality with others.

## Sharing Handlers

We could better organize our handlers in the above examples by grouping them into different files. For example:

```javascript
// my-new-reminder-skill.js
module.exports.activate = function(mailbot) {
  // Handlers can go here
  // mailbot.onCommand...
};
```

Activate the skill's handlers like this (normally done in the top-level to ensure the skill is activated only once):

```javascript
// In top-level app.js
const myNewReminderSkill = require("./my-new-skill")(mailbot);
myNewReminderSkill.activate(mailbot);
```

Isolating your handlers within skills is a great way to keep your project organized. The down-side is that the skill owns each request from beginning to end – not very flexible.

The next sections cover more granular and composable technique. for sharing functionality across multiple handlers or multiple MailBots.

## Sharing the "one-bot function"

A "one-bot function" is a function that takes a single `bot` object (an instance of BotRequest) which, itself, contains the request / response state and utilities to alter the request. It is one instance of a bot request, hence, a one-bot function.

One-bot functions are called within handlers, allowing for a top-level handler to compose multiple one-bot functions to get something done.

```javascript
// sayHi.js
// A simple "one-bot function"
function sayHi(bot) {
  bot.webhook.quickReply("hi");
}
module.exports = sayHi;
```

```javascript
// in main app.js
const sayHi = require("./sayHi.js");
//...
mailbots.onCommand("hi", function(bot) {
  sayHi(bot);
  bot.webhook.respond();
});
```

### Sharing UI Elements

Skills can also share [UI elements][193].

By convention, UI functions that output UI start with `render`. For example, `renderMemorizationControls`.

```javascript
  var memorizeSkill = require("mailbots-memorize");
  memorizeSkill.activate(mailbot); // activate handlers

  mailbot.onCommand("remember", function(bot) {
    bot.webhook.sendEmail({
      to: "you@email.com"
      from: "MailBots",
      subject: "Email Subject"
      body: [
        {
          type: 'title',
          text: 'A Title'
        },

        // Render JSON UI
        memorizeSkill.renderMemorizationControls(bot)
      ]
    })
    bot.webhook.respond();
  }
```

## Handling Web Requests

The `mailbots` framework relies on Express.js for many of its internals. Your skill can access the internal Express `app` object at `mailbot.app`, allowing your skill to do anything that can be done with Express: authenticate other services, interact with APIs, respond to webhooks and render web pages.

Just like in [handling routes in Express][194]:

```javascript
mailbot.app.get("/hi", function(req, res) {
  res.send("<h1>Hi http request!</h1>");
});
```

## Middleware

[Middlware][195] can be exported and "used" by other skills. This is useful for implementing common functionality across multiple handlers.

```javascript
// Export middleware to log everything
function logEverythingMiddleware(req, res, next) {
  const bot = res.locals.bot; // bot lives here
  const emailSubject = bot.get("source.subject");
  require("my-great-logger").log(`Got an email about ${emailSubject}`);
  next(); // <-- Don't forget this!
}
module.exports = logEverythingMiddleware;
};
```

```javascript
// Using our middleware
const logEverythingMiddleware = require("./log-everything");

// Apply to all subsequent handlers
// Note: It does not apply to earlier handlers
mailbot.app.use(logEverythingMiddleware);

mailbot.onCommand("command-one", function(bot) {
  // everything is logged
});
mailbot.onCommand("command-two", function(bot) {
  // everything is logged
});
mailbot.onCommand("command-three", function(bot) {
  // everything is logged
});
```

## Namespacing Conventions

To prevent conflicts and facilitate debugging, it is helpful to follow these conventions. For examples below, our skill is `skill-name`.

-   The module name
        # Example module name
        npm install mailbots-skill-name
-   Store data against the task or bot in a subject with key of the skill name using underscores instead of dashes.
    ```json
    (task.stored_data = { "skill_name": { "key": "val" } })
    ```
-   Preface event names and actions with the skill name or an abbreviation (accounting for [character limitations][196])

    ```javascript
    mailbots.onAction("sn.do-action", bot => {});
    ```

    ### Use of "MailBot", "mailbot", "MailBots" and "bots"

    For clarity and to reduce ambiguity, follow these conventions:

    -   User-Facing: The name of the platform (and company) is "MailBots". Always studly-cased. Always plural.
    -   User-Facing: One email-based bot is a "MailBot". Always studly-cased.
    -   Code: `mailbot` (all lowercased) is an acceptable variable name, but...
    -   Code: When the first "M" is capitalized, always capitalize the second. Ex: `createMailBot()`. `Mailbot` (lowercase "b") never exists.
    -   Code: `bot` is only used for the bot helper object passed to handler functions.

# Installing Skills From npm

Skills can be installed from npm.

Here we will use `mailbots-memorize`, a skill that creates reminders for any [task][184] using [spaced repetition][197], a memorization technique that increases the time between reminders as more reminders are sent.

In your cli, run:

`npm install --save mailbots-memorize`

In our app.js file we will create a handler that uses our newly installed skill.

```javascript
// In main app.js file
var memorizeSkill = require("mailbots-memorize")(mailbot);

mailbot.onCommand("remember", function(bot) {
  memorizeSkill.memorizeTask(bot); //  ⬅ Tell bot to memorize your task
  bot.webhook.quickResponse("Memorizing!");
  bot.webhook.respond();
});

// Called each time the reminder is triggered
mailbot.onTrigger("remember", function(bot) {
  memorizeSkill.memorizeTask(bot); // ⬅ Invoke skill to continue memorizing
  bot.webhook.quickResponse("An email with decreasing frequency");
  bot.webhook.respond();
});
```

## Skills With Side-Effects

Skills that accept the `mailbots` object may automatically alter requests, reply to webhooks or take other action automatically behind the scenes.

> ⚠️ When building sharable skills, use this "automatic" method with caution. Invoking functionality with one line can be both magical and confusingly opaque. The second example below shows an alternative that keeps code more self-documenting and testable.

```javascript
// May automatically handle requets (ex, render settings pages, send emails)
var handleEverything = require("mailbots-handle-everything");
handleEverything(mailbot);
// or
require("handleEverything")(mailbot);
```

Alternatively, skills can export components (middleware, one-bot functions, etc) for you to explicitly use in your handlers.

> 👍 A more self-documenting and testable method.

```javascript
// These types of skills offer components to your handlers
var {
  someMiddleware,
  renderSomething
} = require("mailbots-provide-components");

mailbots.app.use(someMiddleware);

mailbots.onCommand("foo", function(bot) {
  doSomething(bot);
});
```

Different approaches work well for different circumstances. For example, a bot analytics system would be well suited for automatic activation. A toolkit for integrating with a CRM, on the other hand, might make sense as an exported collection of useful middleware and functions.

# Welcoming New Users

When a new user installs your MailBot, they are directed to a settings page with the `welcome` namespace. Render a custom welcome message for your user by creating a settings page that targets this namespace.

```javascript
mailbot.onSettingsViewed(function(bot)  {
    const welcomeSettings = bot.webhook.settingsPage({
      namespace: "welcome", // MailBots sends new users to this namespace automatically
      menuTitle: "Welcome"
    });

    welcomeSettings.text(`
# Welcome To My MailBot
_Markdown_ works here.`);
)}
```

Note: While in dev_mode, the MailBot owner is instead redirected to the sandbox.

Your bot receives the `mailbot.installed` webhook which can be used to schedule a series of welcome emails to the user.

# Connecting 3rd Party Services

Connecting a 3rd party system ( CRMs, todo lists, etc) usually requires an access token or similar information from the 3rd party. The easiest way to connect is to ask the user to copy / paste some generated key, token or URL into their [settings page][22]. A more friendly user experience is to use OAuth.

## OAuth

Use MailBot's internal Express app to provide begin the OAuth process and receive the OAuth callback. Save information on the user's account using the [setMailBotData][198] method (as shown below).

Note: The user's Bearer token is [saved as a cookie on your bot's URL][199] when the user first authorizes your MailBot. This allows you to use the [MailBots SDK][186] when you send a user to a specific URL. (Keep in mind security [XSRF implications][200] if you are doing something sensitve here, like deleting an account). For example:

```javascript
mailbot.app.get("/do-something-for-user", (req, res) => {
  // user's cookies, bearer token, etc are available here
  // redirect elsewhere
});
```

### OAuth Example

Here is is an example OAuth flow, minus the provider-specific logic:

```javascript
// 1. start OAuth handshake, set OAuth state, etc
mailbot.app.get("/connect_provider", (req, res) => {
  res.redirect(providerRedirectUri);
});
```

After the user authorizes with the 3rd party service (todo list, repo, CRM, etc) they are redirected to a callback URL, which does most the work, saves the access token, then redirects the user to their settings page with a success message.

```javascript
// 2. Handle callback after user authorizes on 3rd party site
mailbot.app.get("/provider_callback", async (req, res) => {
  // verify state
  // exchange auth code for token from provider
  // authorize the client SDK and save user's new auth code
  const MailBotsClient = require("@mailbots/mailbots-sdk");
  const mbClient = new MailBotsClient();
  await mbClient.setAccessToken(req.cookies.access_token);
  res.redirect(`${res.locals.bot.config.mailbotSettingsUrl}/success`);
});
```

The work is performed only on your MailBot's url, but to a user, they just click an "Authorize" button on their MailBots settings, connect a 3rd party account and ended up back on their settings page. Service connected, minimal hassle.

# Testing

Export a testable instance of your MailBot by calling `mailbot.exportApp()` instead of calling `mailbot.listen()`. Below is an example of testing the exported app with [Supertest][201].

For a sample request (the `./_fixtures/task.created.json` file below), fire a request and go to the sandbox. Click the "copy" icon that appears when you over over the the top-level key the request JSON.

Note: Set `NODE_ENV` to `testing` to disable webhook validation.

```javascript
const request = require("supertest");
const mocha = require("mocha");
const expect = require("chai").expect;
const MailBotsApp = require("mailbots");
let mailbot; // re-instantiated before each test

// Utility function to send webhook to our app
function sendWebhook({ exportedApp, webhookJson }) {
  return request(exportedApp)
    .post("/webhooks")
    .set("Accept", "application/json")
    .send(webhookJson);
}

describe("integration tests", function() {
  beforeEach(function() {
    mailbot = new MailBotsApp({ clientId: "foo", clientSecret: "bar" });
  });

  it("responds correctly to a webhook", async function() {
    const mailbot = new MailBotsApp({ clientId: "foo", clientSecret: "bar" });

    // set up handlers
    mailbot.onCommand("memorize", bot => {
      bot.webhook.quickReply("I dig email");
      bot.webhook.respond();
    });

    const exportedApp = mailbot.exportApp();
    const webhookJson = require("./_fixtures/task.created.json"); // Copy request from Sandbox
    let { body } = await sendWebhook({ exportedApp, webhookJson });

    // Test our webhook response
    expect(body.send_messages[0].subject).to.equal("I dig email");
  });
});
```

# Installing

The setup process on mailbots.com creates a pre-installed instance of your MailBot using [Glitch][202].

For local development or production deployments:

**1. Install**

-   `mkdir my-bot`
-   `npm init -y`
-   `npm install mailbots`
-   `touch app.js`

**2. Add Setup Code**

```javascript
const MailBot = require("mailbots");
const mailbot = new MailBot({
  clientId: "your_client_id",
  clientSecret: "your_secret",
  mailbotUrl: "http://your_bot_url"
});
// NOTE: The recommended way to set up your MailBot is to set
// CLIENT_ID, CLIENT_SECRET and MAILBOT_URL in env and use dotenv

mailbot.onCommand("hello", bot => {
  bot.webhook.quickReply("world");
  bot.webhook.respond();
});

mailbot.listen();
```

3.  Use [ngrok][203] to set up a public-facing url that MailBots.com can reach.

4.  Create a MailBot at mailbots.com. Click "Manual Setup" at the bottom and follow instructions from there.

# Contributions

Contributions are welcome in the form of PRs and / or Github tickets for issues, bugs, ideas and feature requests.
Please follow the [MailBot naming conventions][204].
We use ngrok to mock API requests, included in the test package here. This can be disabled to test against the live
API (see package.json).


## bot

"Bot" is the helpful object that are given to event handlers. It contains information about the 
request and lots helpful methods to complete the request.

Bots have utilities to handle webhooks **WebHookHelpers**

```javascript
mailbot.onCommand(function(bot) { // <-- This is the "bot"
  bot.webhook.quickReply("hi");
  bot.webhook.respond();
});
```

One of the webhook helpers lets you create a settings form. This is its own class: **SettingsPage**

```javascript
  const mySettingsPage = bot.webhook.settingsPage({
  namespace: "todo",
  title: "ToDo Settings",
  menuTitle: "To Do"
  });
```


## mailbots

A MailBot is an instance of the **MailBots** class. This class exposes handlers
that are used to respond to specific events. (See readme.md for more). 

```javascript
  var MailBots = require("mailbots");
  var mailbot = new MailBots({
    clientId: "foo",
    clientSecret: "bar"
  });

  mailbot.onCommand("hi", function(bot) {
    bot.webhook.quickReply("Hi back!");
    bot.webhook.respond();
  });

  mailbot.listen();
```


## constructor

Class constructor.

### Parameters

-   `instanceConfig`  

## listen

Loads final skills and start http server.
Anything posted to /webhooks route is automatically handled.
Other routes must be created as usual with the Express App object.
For example: mailbots.app.get("my-route/", (req, res) => {});

## exportApp

Export app for automated testing

## loadSkill

Load MailBots skills from a directory, non-recursively.
This can be called more than once to load skills in order. Skills loaded
this method are preceeded by loadFirstCoreSkills, succeeded by loadLastCoreSkills.
This can also receive a path to a file.

### Parameters

-   `skill`  
-   `config` **[object][205]** optional skill configuration object
-   `skillPath` **[string][206]** path to skills directory

**Meta**

-   **deprecated**: This is deprecated.


## on

Add handler for a given webhook event. Executes only the first handler
for a matching event. The first parameter can be either a string
(the named webhook event) or a function that is passed the webhook and
returns true or false to indicate if the handler should be run.
Example: controller.on('task.created', (bot, req, res) => { });
Example: controller.on((webhook) => webhook.event === 'task.created', cb)

### Parameters

-   `triggerCondition`  
-   `cb` **[function][207]** Handler function
-   `opts`  
-   `event` **([string][206] \| [function][207] \| [RegExp][208])** A webhook event string (ex: task.created). Or
    a function receives the webhook as a param, which returns a boolean value.

## onCommand

Captures only 'task.created' events where the command string matches

### Parameters

-   `commandSearch` **([string][206] \| [RegExp][208])** 
-   `cb`  

## onTrigger

Captures only 'task.triggered' events where the command string matches

### Parameters

-   `commandSearch` **([string][206] \| [RegExp][208])** 
-   `cb`  

## onEvent

Captures only 'mailbot.event_received' events
Note: This "Event" refers to the 3rd party webhooks
that are posted to the MailBot.

### Parameters

-   `eventSearch` **([string][206] \| [RegExp][208])** 
-   `cb`  

## onAction

Captures only 'task.action_received' events where the action string matches

### Parameters

-   `actionSearch` **([string][206] \| [RegExp][208])** 
-   `cb`  

## onTaskViewed

Captures only 'task.viewed' events where the command string matches

### Parameters

-   `commandSearch` **([string][206] | RexExp)** 
-   `cb`  

## onSettingsViewed

Handle webhook that fires when user is viewing MailBot.
ALL onSettingsViewed handlers fire when this webhook arrives. Each
handler can add and read data to and from its own namespace.

### Parameters

-   `cb` **[function][207]** Callback function that receives the bot object

## onSettingsSubmit

Handle webhook that fires after a user hits "save" on their MailBot settings.
Newly saved settings arrive at the top-level settings object.
Existing settings are still in mailbot.stored_data.
Return mailbot and user data to save data (as with other webhooks).
ALL onSettingsSubmit handlers fire.

### Parameters

-   `cb` **[function][207]** Callback function that receives the bot object

## initSdkApiClient

Sets an authenticated insteance of MailBots SDK client
[https://github.com/mailbots/mailbots-sdk-js][209] for use in events
and middleware under bot.api. Works both with webhook + web request

### Parameters

-   `req`  
-   `res`  
-   `next`  

## bot.webhook

The 'bot' object passed into the handlers comes with a number
of helpers to handle the request.

NOTE: This class is automatically instantiated with an instance
of BotRequest and made available under bot.webhook.

### Parameters

-   `botRequest` **[object][205]** An instnace of BotRequest

### Examples

```javascript
bot.webhook.getMailBotData('memorize.settings');
```

## get

Get the current value of a key.
If a value has already been been set
on the responseJson object, it return that value,
otherwise it returns the value in the request object.

### Parameters

-   `key` **[string][206]** JSON path to key
-   `defaultValue` **mixed** Default if key is falsy

### Examples

```javascript
bot.webhook.get('source.from'); // sender's email address
```

```javascript
bot.get('source.from'); // this method is also aliased directly on bot
```

## set

Set attributes on the this.responseJson object. If existing value and
new value are both objects (not Arrays) they are shallow-merged.
If new or old data are not objects, the value of the key is replaced
entirely.

### Parameters

-   `key` **[string][206]** JSON Path to object within responseJson object
-   `value` **any** Value
-   `merge` **[boolean][210]** Objets are shallow-merged by default. Set this to
    false to force the replacement of an object.

### Examples

```javascript
bot.set('task.reference_email.subject', "New Subject!");
```

```javascript
bot.set('task.reference_email', { subject: "New Subject!"}); // Same effect as above
```

## getTaskData

Get data for current task

### Parameters

-   `key` **[string][206]** JSON Path to key within task.stored_data
-   `defaultValue` **any** If there is no key, return this

## setTaskData

Set data for current task
Takes either an object or a lodash \_.set path as the first param,
optionally a value as the second parameter. Objects are shallow-merged
if new and old data are objects. (Arrays and other types are replaced).

### Parameters

-   `args` **...any** 

### Examples

```javascript
setTaskData('my_bot.magic_number', 42);
```

## getMailBotData

Get data stored in mailbot.private_data

### Parameters

-   `key` **[string][206]** JSON Path to data from mailbot
-   `defaultValue` **any** If value is undefined, use this value instead

### Examples

```javascript
bot.webhook.getMailBotData('my_bot.setting', 42);
```

## setMailBotData

Set data stored in mailbot.private_data. Objects are shallow merged if
existing data is present. All other values (including arrays) are replaced.

This method has two signatures. It can take an object as its only param
which will be shallowly merged into mailbot.private_data.

It can also take a lodash \_.set path as its first parameter and a value
as the second.

### Parameters

-   `args` **...any** 
-   `param` **([string][206] \| [object][205])** Either a lodash set param or an
    object to be shallowly merged into mailbot.private_data
-   `value` **any?** When passing lodash set path string as first
-   `merge` **any?** When passing lodash set path string as first
    param, this specifies if the data should be shallowly merged or replaced (defaults to true).

### Examples

```javascript
bot.webhook.setMailBotData({key: "value"});
```

```javascript
bot.webhook.setMailBotData('foo.bar', "value");
```

## getReferenceEmail

Get the reference email – the abstract, user-editable instance
of the email associated with this task. Note this is not the same
as the source email (which is the exact email received).

### Examples

```javascript
bot.webhook.getReferenceEmail();
```

## setReferenceEmail

Set reference email
Shallowly merges refernece email fields, allowing
for easy partial updates

### Parameters

-   `referenceEmail` **[object][205]** 
    -   `referenceEmail.to` **[array][211]** Array of email address strings
    -   `referenceEmail.cc` **[array][211]** Array of email address strings
    -   `referenceEmail.bcc` **[array][211]** Array of email address strings
    -   `referenceEmail.subject` **[string][206]** Email subject
    -   `referenceEmail.reply_to` **[string][206]** Email address or action-email
    -   `referenceEmail.html` **[string][206]** html HTML content of email
    -   `referenceEmail.text` **[string][206]** html text-only content of email

### Examples

```javascript
bot.webhook.setReferenceEmail({
  to: "test@gmail.com",
  subject: "A new subject",
  html: "This new content replaces the old"
});
```

## getReplyTo

Get replyto email, taking into this value being edited
after the original email was sent.

### Examples

```javascript
bot.webhook.getReplyTo();
```

Returns **[string][206]** 

## getEmailMethod

Determine if the email command for the current task was placed in the 'to', 'cc' or 'bcc'
fields. This is done by comparing the email command with the email address in the  and 'to', 'cc'
fields. The 'bcc' is hidden from the message envelope but still present in the command.

Note that if the identical email command is in both 'to', 'cc' and 'bcc' it will
only show up as the 'to' method.

## sendEmail

Sends an email by adding an email message object to the "send_messages" array.
Multiple emails can be sent.

### Parameters

-   `email` **[object][205]** email object
    -   `email.to` **[string][206]** comma separated emails
    -   `email.cc` **[string][206]** comma separated emails
    -   `email.bcc` **[string][206]** comma separated emails
    -   `email.from` **[string][206]** from name only (message-envelope is always from mailbots)
    -   `email.reply_to` **[string][206]** email address or action-email
    -   `email.subject` **[string][206]** email subject
    -   `email.body` **[array][211]** Array of ui objects [https://docs.mailbots.com/docs/email-ui-reference][193]

### Examples

```javascript
const email = bot.webhook.sendEmail({
  to: bot.get('source.from'),
  subject: "A Subject",
  body: [
  {
   type: 'html',
   text: '<h1>An email</h1>'
  }];
})

email.from = "New Sender"; // still updatable
```

Returns **[object][205]** A reference to the email object for additional changes

## quickReply

Shorthand method to send a quick reply back to the "from" address
of the incoming email. This accepts either a string or object.
If passing a strong only, the subject and body share the same
text. Pass and object iwth `{subject, body}` to explicitly set
the subject and body

### Parameters

-   `message` **([string][206] \| [object][205])** Content
    -   `message.subject` **[string][206]?** passing an object
    -   `message.body` **[string][206]?** If passing an object

### Examples

```javascript
bot.webhook.quickReply("Got it!");
```

```javascript
botRequest.webhook.quickReply({
   subject: "Quick reply subject",
   body: [{
     type: "title",
     text: "Welcome",
   },
   {
     type: "button",
     behavior: "url",
     text: "Press Me",
     url: "google.com"
   }]
 });
```

## setTriggerTime

Set trigger time for a task using natural language

### Parameters

-   `time` **[string][206]** FollowUpThen-style time description

### Examples

```javascript
bot.webhook.setTriggerTime("monday");
```

```javascript
bot.webhook.setTriggerTime("every2ndWeds");
```

```javascript
bot.webhook.setTriggerTime("everyTuesday2pm");
```

## setTriggerTimestamp

Set trigger time for a task using a unix timestamp

### Parameters

-   `timestamp` **int** Unix timestamp of trigger time

### Examples

```javascript
bot.webhook.setTriggerTimestamp(1546139899);
```

## invite

Trigger MailBots to invite the given email address(es) to use a bot

### Parameters

-   `invitees` **[array][211]** Array of email addresses

### Examples

```javascript
bot.webhook.invite(['user1@email.com','newUser2@gmail.com']);
```

## completeTask

Mark task a completed. The task will be archived until permenantly deleted.

### Examples

```javascript
bot.webhook.completeTask();
```

## discardTask

By default, MailBots creates a task for every command that is visible to the user in their Tasks
list. When this is not desireable (for example, a simple one-time email command) you can use this
method to immediately discard the task.

### Examples

```javascript
bot.webhook.discardTask();
```

## getAllContacts

Fetch all contacts associated with the task's reference_email. User's
address and MailBots addresses are excluded.

Note: This uses reference_email, allowing a user to add
or remove additional recipients from the task.

### Examples

```javascript
bot.webhook.getAllContacts();
```

Returns **[array][211]** Email addresses

## respond

Respond to (and end) the webhook response with the JSON provided.
Multi-fire handlers (like onSettingsViewed) automatically respond.
In the case where an error-condition causes an early return / response
calling this method prevents the handler from trying to return a
second time. Provided JSON is shallowly merged into response object.

### Parameters

-   `json` **[object][205]** Response JSON

### Examples

```javascript
bot.webhook.respond();
```

## settingsPage

Creates a new settings page, rendered in the WebhookHelpers Settings section
of the Admin UI. See SettingsPage docs for details

### Parameters

-   `params` **[object][205]** 
    -   `params.namespace` **[string][206]** Namespace used on mailbot.private_data
    -   `params.title` **[string][206]** Page title (optional, default `""`)
    -   `params.menuTitle` **menuTitle** Menu item title

### Examples

```javascript
const.settingsPage = bot.webhook.settingsPage({
  namespace: "mem",
  title: "Memorization Settings",
  menuTitle: "Memorization"
});
```

## getSource

Get bot request source request object. Usually this is an email. It can also be an API request.

### Examples

```javascript
const source = bot.webhook.getSource()
```

Returns **IWebhookSourceEmail** 

## getTrigger

Get information about the event that
triggered this webhook.

### Examples

```javascript
const trigger = bot.webhook.getTrigger()
```

Returns **IWebhookTrigger** 

## getUser

Get data about the user for which the webhook
was posted.

### Examples

```javascript
const user = bot.webhook.getUser()
```

Returns **IWebhookUser** 

## getTask

Get task data associated with the webhook.

### Examples

```javascript
const task = bot.webhook.getTask()
```

Returns **IWebhookTask** 

## getMailBot

Get mailbot data sent over with each webhook.

### Examples

```javascript
const mailbot = bot.webhook.getMailBot()
```

Returns **IWebHookMailBot** 

## setWebhookStatus

Set webhook status message. If the user is on the web ui, this message flashes
ont eh screen. It also appears in the extension logs.

### Parameters

-   `$0` **[Object][205]** 
    -   `$0.level`   (optional, default `"info"`)
    -   `$0.message`  

### Examples

```javascript
setWebhookStatus({message: "Something worked!"});
```

Returns **void** 

## addFutUiBlocks

Add FUT Email UI Block
Respond with a partial UI element to be injected into an email response. the response schema of
responseJson is different than the other webhooks. It is sent via the Core API directly back
to the fut mailbot, which merges it into its own response webhook response

### Parameters

-   `uiBlocks`  

## bot.webook.settingsPage

Reference for `bot.webhook.settingsPage()`

 Bots and bot skills can create settings settings pages which live
in `responseJson.settings[namespace]`. This class represents one
such settings form. Each settings form lives in its own namespace.
Instantiating a new SettingsPage adds a new namespace to
`responseJson.settings` key and populates it with React JSON Form
Schema JSON. [https://github.com/mozilla-services/react-jsonschema-form][212]
The MailBots Admin UI loops through namespaces, rendering forms appropriately.

NOTE: This class directly mutates MailBot's response JSON to add
settings pages and form fields.

### Examples

```javascript
const mySettingsPage = bot.webhook.settingsPage({
 namespace: "memorize",
 title: "Memorization Settings",
 menuTitle: "Memorization"
});

// Add elements to the page
mySettingsPage.input({ name: "first_name"}); // renders text input
```

## getSettingsFormJSON

Retrieve the JSON Form Schema for this form

### Examples

```javascript
const thisJsonSchema = settingsForm.getSettingsFormJSON();
```

Returns **[object][205]** JSON Form Schema

## insert

Low-level function to insert raw JSONSchema and uiSchema to
create custom form elements.
Mozilla's React JSON Schema Form manages the form JSON and
UI JSON as two separate objects to keep the form JSON prestine and
compliant. This method lets us manage a form element in one place.
Ref: [https://github.com/mozilla-services/react-jsonschema-form][212]

### Parameters

-   `params` **[object][205]** 
    -   `params.name` **[object][205]** Namespace
    -   `params.JSONSchema` **[object][205]** JSON Schema
    -   `params.uiSchema` **[object][205]** Corresponding uiSchemaThis example is taken from [https://mozilla-services.github.io/react-jsonschema-form/][213]

### Examples

```javascript
formPage.insert({
name: "first_name",
JSONSchema: { type: "string", title: "First name" }, // JSON Schema
uiSchema: { "ui:autofocus": true, "ui:emptyValue": "" } // UI Schema
});
```

## input

Add text input field

### Parameters

-   `params` **[Object][205]** 
    -   `params.name` **[string][206]** 
    -   `params.title` **[string][206]** 
    -   `params.description` **[string][206]** 
    -   `params.helpText` **[string][206]** 
    -   `params.placeholder` **[string][206]** 
    -   `params.defaultValue` **[string][206]** 

### Examples

```javascript
formPage.input({
  name: "first_name",
  title:"First Name"
  description: "Type your first name",
  helpText: "Hopefully you don't need help with this",
  placeholder: "(Ex: Bruce Lee)",
  defaultValue: "John Doe",
});
```

## textarea

Add textarea input

### Parameters

-   `params` **[Object][205]** 
    -   `params.name` **[string][206]** 
    -   `params.title` **[string][206]** 
    -   `params.description` **[string][206]** 
    -   `params.helpText` **[string][206]** 
    -   `params.placeholder` **[string][206]** 
    -   `params.defaultValue` **[string][206]** 

### Examples

```javascript
formPage.textarea({
  name: "life_story",
  title:"Life Story",
  description: "This is a long story",
  helpText: "Just start writing",
  placeholder: "Once upon a time...",
  defaultValue: "I was born, some time passed, now I'm here"
});
```

## checkbox

Add checkbox field

### Parameters

-   `params` **[Object][205]** 
    -   `params.name` **[string][206]** 
    -   `params.title` **[string][206]** 
    -   `params.description` **[string][206]** 
    -   `params.helpText` **[string][206]** 
    -   `params.defaultValue` **[string][206]** 

### Examples

```javascript
formPage.checkbox({ name:"confirmation_emails", title:"Confirmation Emails"});
```

## select

Add select dropdown

### Parameters

-   `params` **[Object][205]** 
    -   `params.name` **[string][206]** 
    -   `params.title` **[string][206]** 
    -   `params.description` **[string][206]** 
    -   `params.helpText` **[string][206]** 
    -   `params.options` **[array][211]** Array of options
    -   `params.placeholder` **[string][206]** // when no option is selected
    -   `params.defaultValue` **[string][206]** 

### Examples

```javascript
settingsPage.select({
  name: "favorite_color",
  title: "Favorite Color",
  description: "Which color do you like the best?",
  helpText: "Choose a color",
  options: ["red", "green", "blue"],
  defaultValue: "blue",
  placeholder: "Pick one!"
 });
```

## alert

Adds a custom dialog at the top of the display form that can be used
for interrupt-messaging.

### Parameters

-   `params` **[object][205]** 
    -   `params.title` **[string][206]** Alert box title
    -   `params.text` **[string][206]** Alert box text
    -   `params.buttons` **[array][211]** Array of Button objects (optional, default `[]`)

### Examples

```javascript
formPage.alert({
  title: "Connect",
  text: "Connect GitHub",
  buttons: [{ text: "Submit", type: "Submit "}]
})
```

## video

Insert Video. Only YouTube supported for now.

### Parameters

-   `params` **[object][205]** 
    -   `params.url` **[string][206]** URL of video (optional, default `""`)
    -   `params.type`   (optional, default `"youtube"`)

### Examples

```javascript
formPage.video({
  url: "https://www.youtube.com/watch?v=y1GyXuU2J5k",
  type: "youtube"
})
```

## button

Insert custom button

### Parameters

-   `params` **[object][205]** 
    -   `params.url` **[string][206]** URL of video
    -   `params.text`  
    -   `params.href`   (optional, default `""`)
    -   `params.urlParams`  
    -   `params.className`  
    -   `params.type`  

### Examples

```javascript
formPage.button({
  text: "Google"
  href: "https://www.google.com"
});
```

## setUrlParams

Set URL params in the onSettingsSubmit webhook and onSettingsViewed hook
(ex: ?success=true to show a success dialog)
This provides for an accurate mental model, but internally jumps through a number
of hoops to get this URL to appear in the admin UI.
NOTE: To get current URL params, use bot.get("url_params")

### Parameters

-   `urlParams`  
-   `params`  key value url params

## text

Add a text block. Markdown supported!

### Parameters

-   `text` **[string][206]** – Text with optional markdownNote: This field is whitespace sensitive. New lines
    cannot have leading spaces.

### Examples

```javascript
formPage.text(`--------------
## ️⚠️ Connect Github
This is a text block here. Leading spaces can break this.
And this is a new line.

[Connect Github](http://www.google.com)

------------------
`);
```

## hiddenInput

Render a hidden input field. Useful for submitting
values behind the scenes.

### Parameters

-   `params` **[object][205]** 
    -   `params.name` **[string][206]** Field name
    -   `params.value` **[string][206]** Field value
    -   `params.defaultValue`  

### Examples

```javascript
formPage.hiddenInput({
  name: "key",
  value: "value"
});
```

## submitButton

Render a submit button for the form. (Submit button is not included
automatically). URL params can optionally be passed which makes
them available to the next handler. Make sure to validate URL input.

### Parameters

-   `params` **[object][205]**  (optional, default `{}`)
    -   `params.submitText` **[string][206]** 
    -   `params.urlParams` **[object][205]** Key value of url params

### Examples

```javascript
formPage.submitButton({
  submitText: "Save Settings",
  urlParams: { key: "value" }
});
```

## populate

Populate form data, overwriting default values with those newly passed.
MailBots JSON form data for this namespace can be passed directly to this
method to populate the form values.

### Parameters

-   `formData` **[object][205]** JSON object containing form values.

### Examples

```javascript
const storedData = mailbots.webhook.getMailBotData("mem", {});
formPage.populate(storedData);
```

[1]: #intro

[2]: #bot

[3]: #mailbots

[4]: #constructor

[5]: #parameters

[6]: #listen

[7]: #exportapp

[8]: #loadskill

[9]: #parameters-1

[10]: #on

[11]: #parameters-2

[12]: #oncommand

[13]: #parameters-3

[14]: #ontrigger

[15]: #parameters-4

[16]: #onevent

[17]: #parameters-5

[18]: #onaction

[19]: #parameters-6

[20]: #ontaskviewed

[21]: #parameters-7

[22]: #onsettingsviewed

[23]: #parameters-8

[24]: #onsettingssubmit

[25]: #parameters-9

[26]: #initsdkapiclient

[27]: #parameters-10

[28]: #botwebhook

[29]: #parameters-11

[30]: #examples

[31]: #get

[32]: #parameters-12

[33]: #examples-1

[34]: #set

[35]: #parameters-13

[36]: #examples-2

[37]: #gettaskdata

[38]: #parameters-14

[39]: #settaskdata

[40]: #parameters-15

[41]: #examples-3

[42]: #getmailbotdata

[43]: #parameters-16

[44]: #examples-4

[45]: #setmailbotdata

[46]: #parameters-17

[47]: #examples-5

[48]: #getreferenceemail

[49]: #examples-6

[50]: #setreferenceemail

[51]: #parameters-18

[52]: #examples-7

[53]: #getreplyto

[54]: #examples-8

[55]: #getemailmethod

[56]: #sendemail

[57]: #parameters-19

[58]: #examples-9

[59]: #quickreply

[60]: #parameters-20

[61]: #examples-10

[62]: #settriggertime

[63]: #parameters-21

[64]: #examples-11

[65]: #settriggertimestamp

[66]: #parameters-22

[67]: #examples-12

[68]: #invite

[69]: #parameters-23

[70]: #examples-13

[71]: #completetask

[72]: #examples-14

[73]: #discardtask

[74]: #examples-15

[75]: #getallcontacts

[76]: #examples-16

[77]: #respond

[78]: #parameters-24

[79]: #examples-17

[80]: #settingspage

[81]: #parameters-25

[82]: #examples-18

[83]: #getsource

[84]: #examples-19

[85]: #gettrigger

[86]: #examples-20

[87]: #getuser

[88]: #examples-21

[89]: #gettask

[90]: #examples-22

[91]: #getmailbot

[92]: #examples-23

[93]: #setwebhookstatus

[94]: #parameters-26

[95]: #examples-24

[96]: #addfutuiblocks

[97]: #parameters-27

[98]: #botwebooksettingspage

[99]: #examples-25

[100]: #getsettingsformjson

[101]: #examples-26

[102]: #insert

[103]: #parameters-28

[104]: #examples-27

[105]: #input

[106]: #parameters-29

[107]: #examples-28

[108]: #textarea

[109]: #parameters-30

[110]: #examples-29

[111]: #checkbox

[112]: #parameters-31

[113]: #examples-30

[114]: #select

[115]: #parameters-32

[116]: #examples-31

[117]: #alert

[118]: #parameters-33

[119]: #examples-32

[120]: #video

[121]: #parameters-34

[122]: #examples-33

[123]: #button

[124]: #parameters-35

[125]: #examples-34

[126]: #seturlparams

[127]: #parameters-36

[128]: #text

[129]: #parameters-37

[130]: #examples-35

[131]: #hiddeninput

[132]: #parameters-38

[133]: #examples-36

[134]: #submitbutton

[135]: #parameters-39

[136]: #examples-37

[137]: #populate

[138]: #parameters-40

[139]: #examples-38

[140]: https://www.mailbots.com

[141]: https://docs.mailbots.com/reference#email-commands

[142]: https://mailbots-app.mailbots.com

[143]: #how-mailbots-work

[144]: #tasks

[145]: #commands

[146]: #triggering

[147]: #architecture

[148]: #handlers

[149]: #skills

[150]: #hello-world

[151]: #set-a-reminder

[152]: #handle-action-emails

[153]: #install-a-skill

[154]: #handler-reference

[155]: #handling-errors

[156]: #followupthen-lifecycle-hook-handlers

[157]: #onfutcreateuser

[158]: #onfutcreatenonuser

[159]: #onfutpreviewuser

[160]: #onfutpreviewnonuser

[161]: #onfutviewuser

[162]: #onfutviewnonuser

[163]: #onfuttriggeruser

[164]: #onfuttriggernonuser

[165]: #onfuttaskupdate

[166]: #onfutaction

[167]: #the-bot-object

[168]: #building-skills

[169]: #sharing-handlers

[170]: #sharing-the-one-bot-function

[171]: #handling-web-requests

[172]: #middleware

[173]: #namespacing-conventions

[174]: #installing-skills%C2%A0from-npm

[175]: #skills-with-side-effects

[176]: #welcoming-new-users

[177]: #connecting-3rd-party-services

[178]: #oauth

[179]: #testing

[180]: #installing

[181]: #contributions

[182]: https://app.mailbots.com/sandbox

[183]: https://docs.mailbots.com/reference#email-based-actions

[184]: https://docs.mailbots.com/reference

[185]: https://docs.mailbots.com/reference#perfect-timing

[186]: https://www.npmjs.com/package/@mailbots/mailbots-sdk

[187]: https://mailbots-app.mailbots.com/#settingspage

[188]: https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)

[189]: https://docs.mailbots.com/reference#mailbotinstalled

[190]: https://mailbots-sdk-js.mailbots.com/#sendemaill

[191]: http://help.followupthen.com/knowledge-base/tasks/

[192]: https://mailbots-app.mailbots.com/#webhookhelpers

[193]: https://docs.mailbots.com/docs/email-ui-reference

[194]: https://expressjs.com/en/guide/routing.html

[195]: https://expressjs.com/en/guide/writing-middleware.html

[196]: http://www.rfc-editor.org/errata/eid1690

[197]: https://www.wikiwand.com/en/Spaced_repetition

[198]: #

[199]: https://github.com/mailbots/mailbots/blob/56396fb3d6c00b1895533f9aee3193ae96ac9b45/lib/core-skills-first.js#L104

[200]: https://www.wikiwand.com/en/Cross-site_request_forgery

[201]: https://www.npmjs.com/package/supertest

[202]: https://glitch.com/

[203]: https://ngrok.com/

[204]: https://github.com/mailbots/mailbots#use-of-mailbot-mailbot-mailbots-and-bots

[205]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[206]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

[207]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[208]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/RegExp

[209]: https://github.com/mailbots/mailbots-sdk-js

[210]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

[211]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array

[212]: https://github.com/mozilla-services/react-jsonschema-form

[213]: https://mozilla-services.github.io/react-jsonschema-form/
